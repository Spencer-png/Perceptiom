import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, getDoc, updateDoc, setDoc } from 'firebase/firestore';

// Main App component
const App = () => {
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState('');
    const [loading, setLoading] = useState(false);
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [chatSessions, setChatSessions] = useState([]);
    const [currentSessionId, setCurrentSessionId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false); // New state to track auth readiness

    const messagesEndRef = useRef(null);

    // Scroll to the latest message whenever messages update
    useEffect(() => {
        messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
    }, [messages]);

    // Initialize Firebase and handle authentication
    useEffect(() => {
        try {
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            const app = initializeApp(firebaseConfig);
            const firestoreDb = getFirestore(app);
            const firebaseAuth = getAuth(app);

            setDb(firestoreDb);
            setAuth(firebaseAuth);

            // Listen for auth state changes
            const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                } else {
                    // Sign in anonymously if no token is provided
                    try {
                        if (typeof __initial_auth_token !== 'undefined') {
                            await signInWithCustomToken(firebaseAuth, __initial_auth_token);
                        } else {
                            await signInAnonymously(firebaseAuth);
                        }
                    } catch (error) {
                        console.error("Firebase Auth Error:", error);
                    }
                }
                setIsAuthReady(true); // Set auth ready once initial check is done
            });

            return () => unsubscribe(); // Cleanup auth listener on unmount
        } catch (error) {
            console.error("Failed to initialize Firebase:", error);
        }
    }, []);

    // Fetch chat sessions when auth is ready and userId is available
    useEffect(() => {
        if (!isAuthReady || !db || !userId) return;

        const chatSessionsRef = collection(db, `artifacts/${__app_id}/users/${userId}/chatSessions`);
        const q = query(chatSessionsRef, orderBy('updatedAt', 'desc'));

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const sessions = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            setChatSessions(sessions);

            // If no current session is selected, select the most recent one or create a new one
            if (!currentSessionId && sessions.length > 0) {
                setCurrentSessionId(sessions[0].id);
            } else if (!currentSessionId && sessions.length === 0) {
                createNewChatSession();
            }
        }, (error) => {
            console.error("Error fetching chat sessions:", error);
        });

        return () => unsubscribe();
    }, [isAuthReady, db, userId, currentSessionId]);


    // Fetch messages for the current session
    useEffect(() => {
        if (!isAuthReady || !db || !userId || !currentSessionId) {
            setMessages([]); // Clear messages if no session selected or not ready
            return;
        }

        const sessionDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/chatSessions`, currentSessionId);
        const unsubscribe = onSnapshot(sessionDocRef, (docSnap) => {
            if (docSnap.exists()) {
                setMessages(docSnap.data().messages || []);
            } else {
                setMessages([]);
                console.log("Current session document does not exist.");
            }
        }, (error) => {
            console.error("Error fetching messages for current session:", error);
        });

        return () => unsubscribe();
    }, [isAuthReady, db, userId, currentSessionId]);

    // Create a new chat session
    const createNewChatSession = async () => {
        if (!db || !userId) return;

        setLoading(true);
        try {
            const newSessionRef = await addDoc(collection(db, `artifacts/${__app_id}/users/${userId}/chatSessions`), {
                title: `New Chat ${new Date().toLocaleDateString()}`, // Default title
                messages: [],
                createdAt: new Date(),
                updatedAt: new Date()
            });
            setCurrentSessionId(newSessionRef.id);
            setMessages([]); // Clear messages for the new session
        } catch (error) {
            console.error("Error creating new chat session:", error);
        } finally {
            setLoading(false);
        }
    };

    // Handle sending a message
    const handleSendMessage = async (e) => {
        e.preventDefault();
        if (!input.trim() || loading || !db || !userId || !currentSessionId) return;

        const userMessage = { sender: 'user', text: input.trim(), timestamp: new Date() };
        const updatedMessages = [...messages, userMessage];
        setMessages(updatedMessages);
        setInput('');
        setLoading(true);

        try {
            // Update the current session in Firestore
            const sessionDocRef = doc(db, `artifacts/${__app_id}/users/${userId}/chatSessions`, currentSessionId);
            await updateDoc(sessionDocRef, {
                messages: updatedMessages,
                updatedAt: new Date()
            });

            // Construct the prompt for the LLM, including specific instructions
            let chatHistory = updatedMessages.map(msg => ({
                role: msg.sender === 'user' ? 'user' : 'model', // 'model' for AI
                parts: [{ text: msg.text }]
            }));

            // System prompt to constrain the AI's knowledge
            const systemMessage = {
                role: 'system',
                parts: [{
                    text: `You are an AI chatbot specialized in Lua 5.4 programming language and the Perception.cx API (https://docs.perception.cx/).
                    Your responses must strictly adhere to information available in Lua 5.4 documentation and the Perception.cx API.
                    Do not provide information outside of these two specific topics.
                    If you are asked a question that is outside your scope, please state politely that you cannot answer it as it is beyond your specialized knowledge.
                    When discussing the Perception.cx API, specifically refer to its functions and capabilities, such as those related to rendering, image processing, or watermark creation.
                    For example, if asked about watermarks, you should guide the user towards using the rendering API from Perception.cx.
                    `
                }]
            };

            // Prepend the system message to the chat history for the LLM
            const payloadContents = [systemMessage, ...chatHistory];

            const payload = {
                contents: payloadContents,
                generationConfig: {
                    // You can add more generation configs here if needed, e.g., temperature, top_p, etc.
                }
            };

            const apiKey = ""; // Canvas will automatically provide the API key.
                              // A 401 error indicates that this key might not be correctly provided by the environment.
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            let aiResponseText = "Sorry, I couldn't get a response from the AI.";

            if (!response.ok) {
                const errorBody = await response.text();
                console.error(`AI API Error: HTTP Status ${response.status} - ${response.statusText}`, errorBody);

                if (response.status === 401) {
                    aiResponseText = "Error: Unauthorized. It seems the API key is not being provided correctly by the environment. Please contact support.";
                } else {
                    aiResponseText = `Error from AI: HTTP Status ${response.status}. Please try again later.`;
                }
            } else {
                try {
                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        aiResponseText = result.candidates[0].content.parts[0].text;
                    } else if (result.error) {
                        console.error("AI API Error:", result.error.message);
                        aiResponseText = `Error from AI: ${result.error.message}`;
                    } else {
                        console.error("AI API Response structure unexpected:", result);
                        aiResponseText = "Sorry, the AI returned an unexpected response format.";
                    }
                } catch (jsonError) {
                    const rawText = await response.text();
                    console.error("Error parsing AI API response JSON:", jsonError, "Raw response:", rawText);
                    aiResponseText = "Sorry, I received an unreadable response from the AI. Please try again.";
                }
            }

            const aiMessage = { sender: 'ai', text: aiResponseText, timestamp: new Date() };
            const finalMessages = [...updatedMessages, aiMessage];
            setMessages(finalMessages);

            // Update messages in Firestore again with AI response
            await updateDoc(sessionDocRef, {
                messages: finalMessages,
                updatedAt: new Date()
            });

        } catch (error) {
            console.error("Error sending message to AI or updating Firestore:", error);
            const errorMessage = { sender: 'ai', text: 'An unexpected error occurred while processing your request. Please check your console for details.', timestamp: new Date() };
            setMessages((prevMessages) => [...prevMessages, errorMessage]);
        } finally {
            setLoading(false);
        }
    };

    // Placeholder for Lucide icons (replace with actual imports if needed)
    const LucideIcon = ({ name, size = 20, className = '' }) => {
        // This is a simplified placeholder. In a real app, you'd import specific icons:
        // import { SquarePen, Search, Library, Sparkles, Wand2, ArrowRight } from 'lucide-react';
        // And then return the actual icon component based on `name`.
        // For this example, we'll use inline SVGs or simple text for common icons.
        const icons = {
            'SquarePen': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>,
            'Search': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            'Library': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m16 6 4 14"/><path d="M12 6v14"/><path d="M8 8v12"/><path d="M4 4v16"/></svg>,
            'Sparkles': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9.9 10.9a2 2 0 0 0 0 2.2l4.9 4.9c.8.8 2 .8 2.8 0l2.8-2.8c.8-.8.8-2 0-2.8L12.7 8.1a2 2 0 0 0-2.2 0L5.3 3.7c-.8-.8-2-.8-2.8 0L.5 6.5c-.8.8-.8 2 0 2.8L5.3 14.1a2 2 0 0 0 0 2.2l4.9 4.9c.8.8 2 .8 2.8 0l2.8-2.8c.8-.8.8-2 0-2.8L12.7 8.1a2 2 0 0 0-2.2 0L5.3 3.7c-.8-.8-2-.8-2.8 0L.5 6.5c-.8.8-.8 2 0 2.8L5.3 14.1z"/></svg>,
            'Image': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            'Code': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>,
            'Mic': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>,
            'ChevronRight': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>,
            'SquareUser': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2"/><circle cx="12" cy="10" r="3"/><path d="M7 21v-2a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v2"/></svg>,
            'Ellipsis': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>,
            'MessageSquarePlus': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/><line x1="12" x2="12" y1="8" y2="14"/><line x1="9" x2="15" y1="11" y2="11"/></svg>,
            'ArrowUp': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m5 12 7-7 7 7"/><path d="M12 19V5"/></svg>,
            'Plus': <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>
        };
        return icons[name] || <span className={className}>{name}</span>;
    };


    const renderUserId = () => {
        if (!isAuthReady) {
            return <div className="text-sm text-gray-400">Auth Initializing...</div>;
        }
        if (userId) {
            return (
                <div className="text-xs text-gray-500 truncate mt-2" title={userId}>
                    User ID: {userId}
                </div>
            );
        }
        return <div className="text-sm text-red-400">User ID not available.</div>;
    };

    return (
        <div className="flex h-screen bg-[#202123] text-gray-100 font-inter">
            {/* Sidebar */}
            <div className="w-64 bg-[#202123] flex flex-col justify-between py-2 px-3 border-r border-[#343541]">
                <div>
                    <div className="flex items-center justify-between p-2 mb-2">
                        <span className="text-white text-lg font-semibold">Perception</span>
                        <LucideIcon name="Ellipsis" className="text-gray-400 hover:text-white cursor-pointer" size={20} />
                    </div>

                    <button
                        onClick={createNewChatSession}
                        className="flex items-center gap-2 w-full p-2 text-sm text-gray-300 rounded-md hover:bg-gray-700 hover:text-white transition-colors duration-200"
                        disabled={loading || !isAuthReady}
                    >
                        <LucideIcon name="SquarePen" size={18} /> New chat
                    </button>

                    <div className="mt-4 overflow-y-auto max-h-[calc(100vh-200px)] custom-scrollbar pr-1">
                        {chatSessions.length === 0 && !isAuthReady ? (
                             <p className="text-gray-500 text-sm text-center">Loading sessions...</p>
                        ) : chatSessions.length === 0 ? (
                            <p className="text-gray-500 text-sm text-center">No chat sessions yet. Start a new one!</p>
                        ) : (
                            <>
                                <p className="text-xs text-gray-500 uppercase px-2 py-1">Recent Chats</p>
                                {chatSessions.map(session => (
                                    <button
                                        key={session.id}
                                        onClick={() => setCurrentSessionId(session.id)}
                                        className={`flex items-center gap-2 w-full p-2 text-sm rounded-md transition-colors duration-200 ${
                                            currentSessionId === session.id
                                                ? 'bg-gray-700 text-white'
                                                : 'text-gray-300 hover:bg-gray-700 hover:text-white'
                                        }`}
                                    >
                                        <LucideIcon name="MessageSquarePlus" size={16} />
                                        <span className="truncate">{session.title || `Chat ${session.id.substring(0, 5)}`}</span>
                                    </button>
                                ))}
                            </>
                        )}
                    </div>
                </div>

                <div className="mt-4 border-t border-gray-700 pt-4">
                    {renderUserId()}
                    <a href="#" className="flex items-center gap-2 w-full p-2 text-sm text-gray-300 rounded-md hover:bg-gray-700 hover:text-white transition-colors duration-200">
                        <LucideIcon name="Sparkles" size={18} /> Upgrade plan
                    </a>
                    {/* Placeholder for other potential links */}
                    <a href="#" className="flex items-center gap-2 w-full p-2 text-sm text-gray-300 rounded-md hover:bg-gray-700 hover:text-white transition-colors duration-200">
                        <LucideIcon name="SquareUser" size={18} /> My Account
                    </a>
                </div>
            </div>

            {/* Main chat window */}
            <div className="flex-1 flex flex-col bg-[#343541]">
                {/* Top bar for main content (as per image) */}
                <div className="bg-[#343541] p-3 border-b border-gray-700 flex items-center justify-between text-white shadow-md">
                    <div className="flex items-center gap-2">
                        <span className="font-semibold text-lg">Perception</span>
                        {/* More options icon, if needed from the image */}
                    </div>
                    <div className="flex items-center gap-2">
                        {/* User avatar/settings icon as in ChatGPT */}
                        <div className="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-sm font-bold">S</div>
                        <LucideIcon name="Ellipsis" className="text-gray-400 hover:text-white cursor-pointer" size={20} />
                    </div>
                </div>

                <div className="flex-1 flex flex-col items-center justify-between p-6 overflow-y-auto custom-scrollbar">
                    {messages.length === 0 && !loading && (
                        <div className="flex flex-col items-center justify-center h-full text-center text-gray-400">
                            <h2 className="text-3xl font-bold mb-8 text-white">What are you working on?</h2>
                            <div className="grid grid-cols-2 gap-4 max-w-lg w-full">
                                <div className="p-4 bg-[#444654] rounded-lg shadow-md flex flex-col items-center justify-center text-sm cursor-pointer hover:bg-[#505260] transition-colors">
                                    <LucideIcon name="Image" size={24} className="mb-2" /> Create an image
                                </div>
                                <div className="p-4 bg-[#444654] rounded-lg shadow-md flex flex-col items-center justify-center text-sm cursor-pointer hover:bg-[#505260] transition-colors">
                                    <LucideIcon name="Sparkles" size={24} className="mb-2" /> Get advice
                                </div>
                                <div className="p-4 bg-[#444654] rounded-lg shadow-md flex flex-col items-center justify-center text-sm cursor-pointer hover:bg-[#505260] transition-colors">
                                    <LucideIcon name="Code" size={24} className="mb-2" /> Write code
                                </div>
                                <div className="p-4 bg-[#444654] rounded-lg shadow-md flex flex-col items-center justify-center text-sm cursor-pointer hover:bg-[#505260] transition-colors">
                                    <LucideIcon name="Search" size={24} className="mb-2" /> Summarize text
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="w-full max-w-3xl mx-auto flex-grow flex flex-col justify-end">
                        {messages.map((msg, index) => (
                            <div
                                key={index}
                                className={`flex items-start gap-3 p-4 rounded-lg mb-4 ${
                                    msg.sender === 'user' ? 'bg-[#343541] justify-end' : 'bg-[#444654]'
                                }`}
                            >
                                <div className={`flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${msg.sender === 'user' ? 'bg-blue-500' : 'bg-[#10a37f]'}`}>
                                    {msg.sender === 'user' ? 'U' : 'AI'}
                                </div>
                                <div className={`flex-1 ${msg.sender === 'user' ? 'text-right' : 'text-left'} break-words`}>
                                    <p className="font-semibold text-sm mb-1">
                                        {msg.sender === 'user' ? 'You' : 'AI Assistant'}
                                    </p>
                                    <p className="text-gray-200">{msg.text}</p>
                                    <span className="block text-xs opacity-75 mt-1 text-gray-400">
                                        {new Date(msg.timestamp).toLocaleTimeString()}
                                    </span>
                                </div>
                            </div>
                        ))}
                        {loading && (
                            <div className="flex items-start gap-3 p-4 rounded-lg bg-[#444654] mb-4">
                                <div className="flex-shrink-0 w-8 h-8 rounded-full bg-[#10a37f] flex items-center justify-center font-bold text-sm">AI</div>
                                <div className="flex-1">
                                    <p className="font-semibold text-sm mb-1">AI Assistant</p>
                                    <div className="flex items-center">
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce mr-1"></div>
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-150 mr-1"></div>
                                        <div className="w-2 h-2 bg-gray-400 rounded-full animate-bounce delay-300"></div>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div ref={messagesEndRef} />
                    </div>
                </div>

                {/* Input area */}
                <form onSubmit={handleSendMessage} className="p-4 bg-[#343541] border-t border-gray-700 shadow-inner">
                    <div className="flex items-center max-w-3xl mx-auto bg-[#40414f] rounded-lg pr-2">
                        <input
                            type="text"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            placeholder="Ask anything..."
                            className="flex-1 p-3 bg-transparent border-none focus:outline-none text-white placeholder-gray-400"
                            disabled={loading || !currentSessionId}
                        />
                        <button
                            type="submit"
                            className="p-2 rounded-lg text-gray-400 hover:text-white hover:bg-gray-600 transition-colors duration-200"
                            disabled={loading || !currentSessionId || !input.trim()}
                        >
                            <LucideIcon name="ArrowUp" size={24} />
                        </button>
                    </div>
                    <p className="text-center text-xs text-gray-500 mt-2">
                        Perception may make mistakes. Consider checking important information.
                    </p>
                </form>
            </div>
        </div>
    );
};

export default App;
